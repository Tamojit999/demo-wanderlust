<%- layout('./layouts/boilerplate') %>

    <script>
        const maptoken = "<%= process.env.MAP_TOKEN %>";
        const data = JSON.parse('<%- JSON.stringify(data) %>');
    </script>

    <div class="unique-page-container">

        <!-- Listing Title -->
        <div class="unique-listing-title" style="color: rgb(243, 58, 104);">
            <%= data.title %>
        </div>

        <!-- Listing Image -->
        <div class="unique-listing-image-card">
            <img src="<%= data.image?.url || '/images/default.jpg' %>" alt="Listing Image">
        </div>

        <!-- Listing Info -->
        <div class="unique-listing-info-card">

            <!-- Owner Info -->
            <a href="/owner?name=<%= data.owner.username %>" class="unique-owner-link-wrapper " style="text-decoration: none;">
                <div class="unique-owner-section">
                    <img src="<%= data.owner.image?.url || '/images/default.jpg' %>" alt="Owner Image"
                        class="unique-owner-avatar" >
                    <div class="unique-owner-text mt-2">
                        <span class="unique-owner-badge "><i class="fas fa-user"></i>

                            Host</span>
                        <h3 style="color: rgb(243, 58, 104);">@<%= data.owner.username %>
                        </h3>
                    </div>
                </div>
            </a>

            <!-- Description -->
            <h4>
                <%= data.description %>
            </h4>

            <!-- Price -->
            <h5 style="color: rgba(233, 75, 75, 0.897); font-weight: bolder; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;"><i class="fas fa-indian-rupee-sign" style="color: black;"></i>
            <%= data.price.toLocaleString("en-IN") %>/night
            </h5>

            <!-- Location -->
            <h5 ><i class="fas fa-map-marker-alt" style="color: rgb(12, 12, 12);"></i>
            <%= data.location %>, <%= data.country %>
            </h5>

           

        </div>
         <!-- Edit/Delete Buttons (only if current user is owner) -->
            <% if (curr && data.owner._id.equals(curr._id)) { %>
                <div class="unique-action-buttons">
                    <form method="GET" action="/listings/<%= data._id %>/edit" class="unique-form">
                        <button type="submit" class="unique-edit-btn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </form>

                    <form method="POST" action="/listings/<%= data._id %>?_method=DELETE" class="unique-form">
                        <button type="submit" class="unique-delete-btn">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </form>
                </div>
           
            <% } else { %>
                <form method="GET" action="/listings/<%= data._id %>/book" class="unique-form">
                        <button type="submit" class="newbtn">
                         Book now
                        </button>
                    </form>

                <% } %>

        <!-- Map -->
        <div class="unique-map-section">
            <h3 class="mt-2">Where you will be</h3>
            <div id="map"></div>
        </div>

        <!-- Review Form -->
        <% if (curr) { %>
            <div class="unique-review-section">
                <h3 class="unique-review-heading">Leave a Review</h3>

                <form method="POST" action="/listings/<%= data._id %>/review"
                    class="unique-review-form needs-validation" novalidate>
                    <div class="form-group">
                        <label for="rating" class="form-label">Rate</label>
                        <fieldset class="starability-slot">
                            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1"
                                checked aria-label="No rating." />
                            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                            <label for="first-rate1" title="Terrible">1 star</label>
                            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                            <label for="first-rate2" title="Not good">2 stars</label>
                            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                            <label for="first-rate3" title="Average">3 stars</label>
                            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                            <label for="first-rate4" title="Very good">4 stars</label>
                            <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                            <label for="first-rate5" title="Amazing">5 stars</label>
                        </fieldset>
                    </div>

                    <div class="form-group">
                        <label for="comment" class="form-label">Add a comment</label>
                        <textarea name="review[comment]" id="comment" rows="5" cols="40" class="form-control"
                            required></textarea>
                        <div class="invalid-feedback">Please add a comment!</div>
                    </div>

                    <button class="unique-submit-btn" type="submit">Submit</button>
                </form>
            </div>
            <% } %>

                <!-- Reviews List -->
                <div class="unique-review-list">
                    <h3 class="unique-review-list-heading mt-3">Reviews</h3>

                    <% if (data.review && data.review.length> 0) { %>
                        <div class="unique-reviews-container">
                            <% for (let r of data.review) { %>
                                <div class="unique-review-card">
                                    <!-- Header: Avatar + Username -->
                                    <div class="unique-review-header">
                                        <img src="<%= r.auther.image?.url || '/images/default.jpg' %>"
                                            alt="<%= r.auther.username %>" class="unique-review-user-image">
                                        <h5 class="unique-review-username"><%= r.auther.username %>
                                        </h5>
                                    </div>

                                    <!-- Rating -->
                                    <div class="unique-review-rating">
                                        <% for (let i=1; i <=5; i++) { %>
                                            <% if (i <=r.rating) { %>
                                                <i class="fas fa-star filled"></i>
                                                <% } else { %>
                                                    <i class="far fa-star"></i>
                                                    <% } %>
                                                        <% } %>
                                    </div>

                                    <!-- Review Comment -->
                                    <p class="unique-review-text">
                                        <%= r.comment %>
                                    </p>

                                    <!-- Delete Button (only for author) -->
                                    <% if (curr && r.auther._id.equals(curr._id)) { %>
                                        <form action="/listings/<%= data._id %>/review/<%= r._id %>?_method=DELETE"
                                            method="POST">
                                            <button class="unique-delete-btn" type="submit">
                                                <i class="fas fa-trash-alt"></i> Delete
                                            </button>
                                        </form>
                                        <% } %>
                                </div>
                                <% } %>
                        </div>
                        <% } else { %>
                            <p class="unique-no-reviews">No reviews yet.</p>
                            <% } %>
                </div>

    </div>

    <script src="/javascript/map.js"></script>